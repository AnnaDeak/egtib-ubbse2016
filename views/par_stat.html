{% extends "basePage.html" %}

{% block head %}
	<title> Simulation </title>
    <link rel="stylesheet" href="/stylesheets/voronoi_style.css">
    <script type="text/javascript" src="/javascripts/paper-full.js"></script>
    <script type="text/javascript" src="http://paperjs.org/assets/js/rhill-voronoi-core.js"></script>
    <script type="text/paperscript" canvas="canvas">
        var voronoi = new Voronoi();
        var sites = generateBeeHivePoints(view.size / 50, true);
        var bbox, diagram;
        var oldSize = view.size;
        var spotColor = new Color('green');
        var mousePos = view.center;
        var selected = false;

        onResize();

        function onMouseDown(event) {
            sites.push(event.point);
            renderDiagram();
        }

        function onMouseMove(event) {
            mousePos = event.point;
            if (event.count == 0)
                sites.push(event.point);
            sites[sites.length - 1] = event.point;
            renderDiagram();
        }

        function renderDiagram() {
            project.activeLayer.removeChildren();
            var diagram = voronoi.compute(sites, bbox);
            if (diagram) {
                for (var i = 0, l = sites.length; i < l; i++) {
                    var cell = diagram.cells[sites[i].voronoiId];
                    if (cell) {
                        var halfedges = cell.halfedges,
                            length = halfedges.length;
                        if (length > 2) {
                            var points = [];
                            for (var j = 0; j < length; j++) {
                                v = halfedges[j].getEndpoint();
                                points.push(new Point(v));
                            }
                            createPath(points, sites[i]);
                        }
                    }
                }
            }
        }

        function removeSmallBits(path) {
            var averageLength = path.length / path.segments.length;
            var min = path.length / 50;
            for(var i = path.segments.length - 1; i >= 0; i--) {
                var segment = path.segments[i];
                var cur = segment.point;
                var nextSegment = segment.next;
                var next = nextSegment.point + nextSegment.handleIn;
                if (cur.getDistance(next) < min) {
                    segment.remove();
                }
            }
        }

        function generateBeeHivePoints(size, loose) {
            var points = [];
            var col = view.size / size;
            for(var i = -1; i < size.width + 1; i++) {
                for(var j = -1; j < size.height + 1; j++) {
                    var point = new Point(i, j) / new Point(size) * view.size + col / 2;
                    if (j % 2)
                        point += new Point(col.width / 2, 0);
                    if (loose)
                        point += (col / 4) * Point.random() - col / 4;
                    points.push(point);
                }
            }
            return points;
        }
        function createPath(points, center) {
            var path = new Path();
            if (!selected) {
               path.fillColor = new Color((Math.random()),(Math.random()),(Math.random()));
            } else {
                path.fullySelected = selected;
            }
            path.closed = true;

            for (var i = 0, l = points.length; i < l; i++) {
                var point = points[i];
                var next = points[(i + 1) == points.length ? 0 : i + 1];
                var vector = (next - point) / 2;
                path.add({
                    point: point + vector,
                    handleIn: -vector,
                    handleOut: vector
                });
            }
            path.scale(0.95);
            removeSmallBits(path);
            return path;
        }

        function onResize() {
            var margin = 20;
            bbox = {
                xl: margin,
                xr: view.bounds.width - margin,
                yt: margin,
                yb: view.bounds.height - margin
            };
            for (var i = 0, l = sites.length; i < l; i++) {
                sites[i] = sites[i] * view.size / oldSize;
            }
            oldSize = view.size;
            renderDiagram();
        }

        function onKeyDown(event) {
            if (event.key == 'space') {
                selected = !selected;
                renderDiagram();
            }
        }
    </script>

    <script type="text/javascript">
    	$( document ).ready(function() {
    		var chart = Highcharts.chart('container', {

		        chart: {
		            type: 'column'
		        },

		        title: {
		            text: 'Number of cells, over time'
		        },

		        xAxis: {
		            categories: []
		        },

		        yAxis: {
		            allowDecimals: false,
		            min: 0,
		            title: {
		                text: 'Number of cells'
		            }
		        },

		        tooltip: {
		            formatter: function () {
		                return '<b>' + this.x + '</b><br/>' +
		                    this.series.name + ': ' + this.y + '<br/>' +
		                    'Total: ' + this.point.stackTotal;
		            }
		        },

		        plotOptions: {
		            column: {
		                stacking: 'normal'
		            }
		        },

		        series: [{
		            name: 'Productive',
		            color: '#f36205',
		            data: [],
		        }, {
		            name: 'Non-productive',
		            color: '#2f98da',
		            data: [],
		        }, {
			        name: 'NS',
			        type: 'spline',
			        color: '#000000',
			        data: [],
			    }]
		    });
		
		    var n = Math.ceil(Math.random()*1000); //ezt kell megkapjam
		    var categories = [];
		    var numberProductive = [];
		    var numberNonProductive = [];
		    for (i = 0; i<50; i++) {
		    	var p = Math.ceil(Math.random()*n); //ezt kell megkapjam
		    	numberProductive.push(p);
		    	numberNonProductive.push(n-p);
		    	categories.push(i+1);
		    }
		    chart.series[0].setData(numberProductive);
		    chart.series[1].setData(numberNonProductive);
		    chart.series[2].setData(numberNonProductive);
		    
		    chart.xAxis[0].setCategories(categories); 

		});
    	var number, number_non;
		function submit1() {
			number = Number(document.getElementById('number').value);
			console.log(number);
			number_non = Number(document.getElementById('number_non').value);
			console.log(number_non);
		}

		function submit2() {
			presets = document.getElementById('presets').value;
			console.log(presets);
		}

    </script>
{% endblock %}

{% block body %}

			<div class="row" >
				<div class="col-sm-4">
				 	<div class="panel panel-default">
			     		<div class="panel-heading" style="background-color: rgb(40,40,40); color: rgb(255,255,255);">Set the parameters for the next run here:</div>
			      		<div class="panel-body" style="text-align: center">
			      			<label>Enter your own parameters:</label><br><br>
			      			<form style="text-align: left">
							    <div class="form-group">
							      <label for="number">Total number of particles:</label>
							      <input type="number" class="form-control" id="number">
							    </div>
							    <div class="form-group">
							      <label for="number_non">Number of non-productive cells:</label>
							      <input type="number" class="form-control" id="number_non">
							    </div>
							    <input type="button" class="btn btn-default" onclick="submit1();" value="Submit"/>
						 	</form><br>

						 	<label> --------------- OR ---------------</label><br><br>

						 	<label>Select a preset:</label><br><br>
			      			<form style="text-align: left">
			      				<div class="form-group">
									<label for="presets">Choose your preset:</label>
									<select class="form-control" id="presets">
										<option>Default cancer</option>
									</select>
								</div>

								<input type="button" class="btn btn-default" onclick="submit2();" value="Submit"/>
						 	</form>
			      		</div>
			    	</div>
				</div>
				<div class="col-sm-8" style = "height: 50%">
				 	<div class="panel panel-default">
			      		<canvas id="canvas" resize></canvas>
			    	</div>
				</div>	 
			</div>
			<div class="row">
				<div class="panel panel-default">
					<div class="panel-heading" style="background-color: rgb(40,40,40); color: rgb(255,255,255); text-align: center;">Statistics</div>
					<div class="panel-body" style="text-align: center">
						<div id = "container">
						</div>
					</div>
				</div>
			</div>

{% endblock %}